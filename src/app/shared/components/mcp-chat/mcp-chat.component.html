<!-- src/app/shared/components/mcp-chat/mcp-chat.component.html -->

<!-- Botón para mostrar/ocultar chat -->
<div class="d-flex align-items-center justify-content-between p-3 bg-light border rounded cursor-pointer"
     (click)="toggleChat()"
     style="cursor: pointer; transition: all 0.3s ease;"
     onmouseover="this.style.backgroundColor='#e9ecef'"
     onmouseout="this.style.backgroundColor='#f8f9fa'">
  <div class="d-flex align-items-center">
    <i class="bi bi-robot me-2 text-primary" *ngIf="!isSidebarCollapsed"></i>
    <span *ngIf="!isSidebarCollapsed" class="fw-bold">AI Assistant</span>
    <i class="bi bi-robot text-primary" *ngIf="isSidebarCollapsed"></i>
  </div>
  <i class="bi" 
     [class.bi-chevron-up]="isExpanded" 
     [class.bi-chevron-down]="!isExpanded"
     *ngIf="!isSidebarCollapsed"></i>
</div>

<!-- Panel del chat como overlay completo -->
<div class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center"
     style="background-color: rgba(0,0,0,0.5); z-index: 1060;"
     *ngIf="isExpanded"
     (click)="toggleChat()">
  
  <div class="bg-white rounded shadow-lg d-flex flex-column"
       style="width: 90%; max-width: 500px; height: 80%; max-height: 600px;"
       (click)="$event.stopPropagation()">
    
    <!-- Header del chat -->
    <div class="p-3 bg-light border-bottom">
      <div class="d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <i class="bi bi-robot me-2 text-primary"></i>
          <span class="fw-bold" *ngIf="!isSidebarCollapsed">AI Assistant</span>
        </div>
        <div class="d-flex align-items-center">
          <!-- Estado del chat -->
          <small class="me-2" [class]="getChatStateClass()">
            {{ getChatStateText() }}
          </small>
          <!-- Botones de acción -->
          <div class="btn-group" role="group">
            <button type="button" 
                    class="btn btn-sm btn-outline-secondary" 
                    (click)="clearChat()"
                    title="Limpiar chat">
              <i class="bi bi-trash"></i>
            </button>
            <button type="button" 
                    class="btn btn-sm btn-outline-secondary" 
                    (click)="resetSession()"
                    title="Reiniciar sesión">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
            <button type="button" 
                    class="btn btn-sm btn-outline-secondary" 
                    (click)="toggleChat()"
                    title="Cerrar">
              <i class="bi bi-x"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenedor de mensajes -->
    <div class="flex-fill overflow-auto p-3" 
         #messagesContainer
         style="max-height: 350px; scrollbar-width: thin;">
      
      <div *ngFor="let message of messages; trackBy: trackByMessageId" 
           class="mb-3">
        
        <!-- Mensaje del usuario -->
        <div *ngIf="message.role === 'user'" class="d-flex justify-content-end">
          <div class="d-flex align-items-start" style="max-width: 80%;">
            <div class="me-2">
              <div class="p-2 bg-primary text-white rounded">
                <div class="mb-1">{{ message.content }}</div>
                <small class="opacity-75" style="font-size: 0.75rem;">
                  {{ formatTimestamp(message.timestamp) }}
                </small>
              </div>
            </div>
            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" 
                 style="width: 32px; height: 32px; flex-shrink: 0;">
              <i class="bi bi-person-circle"></i>
            </div>
          </div>
        </div>

        <!-- Mensaje del asistente -->
        <div *ngIf="message.role === 'assistant'" class="d-flex justify-content-start">
          <div class="d-flex align-items-start" style="max-width: 80%;">
            <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center me-2" 
                 style="width: 32px; height: 32px; flex-shrink: 0;">
              <i class="bi bi-robot"></i>
            </div>
            <div class="p-2 bg-light border rounded">
              <!-- Mensaje con loading -->
              <div *ngIf="message.isLoading" class="d-flex align-items-center text-muted fst-italic">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                  <span class="visually-hidden">Cargando...</span>
                </div>
                <span>Escribiendo...</span>
              </div>
              
              <!-- Mensaje normal -->
              <div *ngIf="!message.isLoading">
                <div class="mb-1" style="white-space: pre-wrap; word-wrap: break-word;">
                  {{ message.content }}
                </div>
                <small class="text-muted" style="font-size: 0.75rem;">
                  {{ formatTimestamp(message.timestamp) }}
                </small>
              </div>
              
              <!-- Error -->
              <div *ngIf="message.error" class="text-danger small mt-1">
                <i class="bi bi-exclamation-triangle me-1"></i>
                {{ message.error }}
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Mensaje cuando no hay mensajes -->
      <div *ngIf="messages.length === 0" class="d-flex align-items-center justify-content-center h-100">
        <div class="text-center text-muted">
          <i class="bi bi-chat-dots" style="font-size: 4rem;"></i>
          <p class="mt-3 mb-0">¡Hola! Soy tu asistente de e-commerce.<br>
             Pregúntame sobre productos, clientes o pedidos.</p>
        </div>
      </div>
    </div>

    <!-- Formulario de entrada -->
    <div class="p-3 border-top bg-light">
      <form [formGroup]="chatForm" (ngSubmit)="sendMessage()">
        <div class="input-group">
          <textarea 
            class="form-control"
            formControlName="message"
            placeholder="Escribe tu mensaje..."
            rows="2"
            (keydown)="onKeyDown($event)"
            style="resize: none;"></textarea>
          
          <button 
            type="submit" 
            class="btn btn-primary"
            [disabled]="!chatForm.get('message')?.value?.trim() || chatState === 'loading'">
            <span *ngIf="chatState !== 'loading'">
              <i class="bi bi-send"></i>
            </span>
            <span *ngIf="chatState === 'loading'">
              <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Enviando...</span>
              </div>
            </span>
          </button>
        </div>
      </form>
      
      <!-- Sugerencias -->
      <div class="mt-2" *ngIf="messages.length <= 1">
        <small class="text-muted">Prueba preguntar:</small>
        <div class="d-flex flex-wrap gap-1 mt-1">
          <button type="button" 
                  class="btn btn-sm btn-outline-secondary"
                  (click)="chatForm.patchValue({message: suggestion})"
                  *ngFor="let suggestion of getSuggestions()">
            {{ suggestion }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
