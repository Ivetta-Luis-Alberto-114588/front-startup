<!-- src/app/admin/pages/order-status-dashboard/order-status-dashboard.component.html -->
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="h3 mb-1">
                        <i class="bi bi-kanban me-2"></i>
                        Dashboard de Estados de Pedidos
                    </h2>
                    <p class="text-muted mb-0">Vista general de pedidos organizados por estado</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" (click)="refreshData()" [disabled]="isLoading">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        Actualizar
                    </button>
                    <button class="btn btn-primary" routerLink="/admin/orders">
                        <i class="bi bi-list-ul me-1"></i>
                        Ver Lista Completa
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3 text-muted">Cargando estados de pedidos...</p>
    </div>    <!-- Error State -->
    <div *ngIf="errorMessage && !isLoading && !hasOrderStatuses()" class="alert alert-danger" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        {{ errorMessage }}
        <button class="btn btn-sm btn-outline-danger ms-2" (click)="refreshData()">
            Reintentar
        </button>
    </div>

    <!-- Warning State (Limited Mode) -->
    <div *ngIf="isLimitedMode()" class="alert alert-warning" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>Modo Limitado:</strong> Los estados de pedidos se han cargado correctamente, pero hay un problema con los datos de las órdenes en el servidor. 
        Solo se muestran los estados disponibles sin órdenes asociadas.
        <div class="mt-2">
            <small class="text-muted">{{ errorMessage }}</small>
        </div>
        <button class="btn btn-sm btn-outline-warning ms-2" (click)="refreshData()">
            Reintentar cargar órdenes
        </button>
    </div>

    <!-- Dashboard Content -->
    <div *ngIf="!isLoading && hasOrderStatuses()" class="row">
        <!-- Summary Cards -->
        <div class="col-12 mb-4">
            <div class="row g-3">
                <div class="col-xl-3 col-lg-4 col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                                        <i class="bi bi-receipt text-primary fs-4"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1 text-muted">Total de Pedidos</h6>
                                    <h4 class="mb-0">{{ getTotalOrders() }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-lg-4 col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                                        <i class="bi bi-clock-history text-warning fs-4"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1 text-muted">Pendientes</h6>
                                    <h4 class="mb-0">{{ getOrderCountByStatus('PENDING') }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-lg-4 col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="bg-info bg-opacity-10 rounded-circle p-3">
                                        <i class="bi bi-gear text-info fs-4"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1 text-muted">En Proceso</h6>
                                    <h4 class="mb-0">{{ getOrderCountByStatus('PROCESSING') }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-lg-4 col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="bg-success bg-opacity-10 rounded-circle p-3">
                                        <i class="bi bi-check-circle text-success fs-4"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1 text-muted">Completados</h6>
                                    <h4 class="mb-0">{{ getOrderCountByStatus('COMPLETED') }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Status Columns -->
        <div class="col-12">
            <div class="row g-3">
                <div *ngFor="let status of orderStatuses; trackBy: trackByStatusId" class="col-xl-3 col-lg-4 col-md-6">

                    <!-- Status Column Header -->
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header border-0 pb-0" [style.background-color]="status.color + '20'">
                            <div class="d-flex align-items-center justify-content-between">                                <div class="d-flex align-items-center">
                                    <i [class]="orderStatusService.getStatusIcon(status.name)"
                                        [style.color]="status.color" class="me-2 fs-5"></i>
                                    <div>
                                        <h6 class="mb-1 fw-bold">{{ status.name }}</h6>
                                        <small class="text-muted">{{ status.description }}</small>
                                    </div>
                                </div>
                                <span class="badge rounded-pill" [style.background-color]="status.color">
                                    {{ getOrdersByStatus(status.name).length }}
                                </span>
                            </div>
                        </div>

                        <!-- Orders List -->
                        <div class="card-body pt-3">
                            <div class="order-list" style="max-height: 400px; overflow-y: auto;">                                <!-- No orders message -->
                                <div *ngIf="getOrdersByStatus(status.name).length === 0"
                                    class="text-center text-muted py-4">
                                    <i class="bi bi-inbox fs-1 d-block mb-2 opacity-25"></i>
                                    <small>No hay pedidos en este estado</small>
                                </div>

                                <!-- Order Cards -->
                                <div *ngFor="let order of getOrdersByStatus(status.name); trackBy: trackByOrderId"
                                    class="order-card mb-3 p-3 border rounded-3 bg-light">

                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <h6 class="mb-1 fw-bold">#{{ order.id.substring(0, 8) }}</h6>
                                            <small class="text-muted">
                                                <i class="bi bi-person me-1"></i>
                                                {{ order.customer?.name || 'Cliente' }}
                                            </small>
                                        </div>
                                        <div class="text-end">
                                            <div class="fw-bold text-success">${{ order.total.toFixed(2) || '0.00' }}
                                            </div>
                                            <small class="text-muted">
                                                {{ formatDate(order.createdAt) }}
                                            </small>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <small class="text-muted">
                                                <i class="bi bi-box me-1"></i>
                                                {{ order.items.length || 0 }} productos
                                            </small>
                                        </div>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary btn-sm"
                                                [routerLink]="['/admin/orders', order.id]" title="Ver detalles">
                                                <i class="bi bi-eye"></i>
                                            </button> <button class="btn btn-outline-secondary btn-sm"
                                                (click)="openStatusChangeModal(order)"
                                                [disabled]="getTransitionableStatuses(order.status || '').length === 0"
                                                title="Cambiar estado">
                                                <i class="bi bi-arrow-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Change Modal -->
<div class="modal fade" id="statusChangeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-right-circle me-2"></i>
                    Cambiar Estado del Pedido
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" *ngIf="selectedOrder">
                <div class="mb-3">
                    <h6>Pedido #{{ selectedOrder.id.substring(0, 8) }}</h6>
                    <p class="text-muted mb-0">{{ selectedOrder.customer?.name }}</p>
                </div>

                <div class="mb-3">
                    <label class="form-label">Nuevo Estado:</label>
                    <select class="form-select" [(ngModel)]="newStatusId">                        <option value="">Seleccionar estado...</option>
                        <option *ngFor="let status of getTransitionableStatuses(selectedOrder.status || '')"
                            [value]="status._id">
                            {{ status.name }} - {{ status.description }}
                        </option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Notas (opcional):</label>
                    <textarea class="form-control" rows="3" [(ngModel)]="statusChangeNotes"
                        placeholder="Agregar comentarios sobre el cambio de estado..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" (click)="updateOrderStatus()"
                    [disabled]="!newStatusId || isUpdatingStatus">
                    <span *ngIf="isUpdatingStatus" class="spinner-border spinner-border-sm me-2"></span>
                    Cambiar Estado
                </button>
            </div>
        </div>
    </div>
</div>